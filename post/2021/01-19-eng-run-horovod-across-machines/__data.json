{"type":"data","nodes":[null,{"type":"data","data":[{"html":1,"frontmatter":2,"date":14,"lang":15,"tocData":16},"\u003Cp>If you are trying to do some deep learning,\nyou would want them to run inside a Docker,\nbecause deep learning frameworks are quite tricky and\nit is not easy to set the environment at once.\n\u003Cbr>\u003C/p>\n\u003C!--more-->\n\u003Cp>They are sensitive to the run time environment,\nso you would likely to install them over and over again,\nand the situation could go worse and worse that\nyou cannot go back to the initial environment.\n\u003Cbr>\u003C/p>\n\u003Cp>This is why you would need Docker, since they can be isolated\nfrom outside of the container,\nand even if something goes wrong,\nyou can just remove the container and install again.\u003Cbr>\nMoreover, installation does not take too long!\n\u003Cbr>\u003C/p>\n\u003Cp>Docker is not a virtual machine and but is similar to a virtual machine.\nBut unlike other virtual machines, Docker shares OS with the host and\nthat is the main advantage of Docker being lightweight.\n\u003Cbr>\u003C/p>\n\u003Cp>Running Horovod inside a container is an easy one.\u003Cbr>\nYou can just download pre-defined Docker images built\n(e.g. \u003Ca href=\"https://ngc.nvidia.com/catalog/containers/nvidia:tensorflow\">https://ngc.nvidia.com/catalog/containers/nvidia:tensorflow\u003C/a>),\nand run Horovod with argument you like.\n\u003Cbr>\u003C/p>\n\u003Cp>However, it is not easy to run Horovod across multiple machines or nodes, especially if you run it\n\u003Cstrong>inside Docker container\u003C/strong> and there are little information on the internet.\u003Cbr>\nSince I was one who had trouble like above, and even if I still do not understand\nwhat was the root causes of the problem, I take a note and leave it here for someone or for myself.\u003Cbr>\nI could finally run Horovod across multiple machines with helps from other people.\u003C/p>\n\u003Ch2 id=\"1-1.-Run-(Install)-Docker-Image\">1. Run (Install) Docker Image\u003C/h2>\n\u003Cp>First you need Docker and a proper Docker image. Get one if you do not have yet, such as the link above.\u003Cbr>\n\u003Cstrong>Note\u003C/strong> that You may need to download latest image. I had trouble with image from march 2020\n(but not sure whether it was the cause of the problem), and resolved with one from september 2020.\u003Cbr>\nI had a problem where Horovod could not find common interface even if there was.\n\u003Cbr>\u003C/p>\n\u003Cp>I ran Docker containers with the following command:\u003C/p>\n\u003Cpre class=\"language-bash\">\u003Ccode class=\"language-bash code-highlight\">\u003Cspan class=\"code-line line-number\" line=\"1\">\u003Cspan class=\"token function\">docker\u003C/span> run \u003Cspan class=\"token parameter variable\">--gpus\u003C/span> all \u003Cspan class=\"token parameter variable\">-it\u003C/span> --cap-add sys_admin \u003Cspan class=\"token punctuation\">\\\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"2\">    --cap-add sys_ptrace --security-opt \u003Cspan class=\"token assign-left variable\">seccomp\u003C/span>\u003Cspan class=\"token operator\">=\u003C/span>unconfined \u003Cspan class=\"token punctuation\">\\\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"3\">    --shm-size\u003Cspan class=\"token operator\">=\u003C/span>50g \u003Cspan class=\"token parameter variable\">--ulimit\u003C/span> \u003Cspan class=\"token assign-left variable\">memlock\u003C/span>\u003Cspan class=\"token operator\">=\u003C/span>-1 \u003Cspan class=\"token parameter variable\">--ipc\u003C/span>\u003Cspan class=\"token operator\">=\u003C/span>host \u003Cspan class=\"token parameter variable\">-v\u003C/span> /data:/data \u003Cspan class=\"token punctuation\">\\\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"4\">    \u003Cspan class=\"token parameter variable\">--network\u003C/span> \u003Cspan class=\"token function\">host\u003C/span> \u003Cspan class=\"token parameter variable\">--name\u003C/span> docker_name \u003Cspan class=\"token parameter variable\">--hostname\u003C/span> docker_name \u003Cspan class=\"token punctuation\">\\\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"5\">    nvcr.io/nvidia/tensorflow:20.10-tf1-py3\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The point is \u003Ccode>--network host\u003C/code>. It means the container can use the host machine's network stack,\nand the network interfaces are visible to the container.\u003Cbr>\nBriefly, the same network is shared between the host and the container.\nThis will make ssh communication settings much simpler.\n\u003Cbr>\u003C/p>\n\u003Cp>I had a few experiments and it seems that you can make ssh connections between containers with \u003Ccode>-p\u003C/code> argument to proxy between host's port and docker's port,\nbut an error would occur while running Horovod.\u003Cbr>\nIt seems not technically explainable, but Horovod does not work with \u003Ccode>-p\u003C/code>.\nUse \u003Ccode>--network host\u003C/code> instead.\n\u003Cbr>\u003C/p>\n\u003Ch2 id=\"2-2.-ssh-Settings\">2. ssh Settings\u003C/h2>\n\u003Cp>Essentially Horovod is implemented with ssh connection and\nit is important to clarify that there is no problem in ssh connection or user input prompt on ssh connection.\n\u003Cbr>\u003C/p>\n\u003Cp>You need to generate ssh keys and copy public keys from one to the others\nso that user input is not needed while communicating on ssh.\n\u003Cbr>\u003C/p>\n\u003Cp>Briefly, generate ssh keys by \u003Ccode>ssh-keygen -t rsa\u003C/code> and copy the resulted \u003Ccode>/(id)/.ssh/id_rsa.pub\u003C/code> into the other machines\nwith the name \u003Ccode>/(id)/.ssh/authorized_keys\u003C/code>.\u003Cbr>\n\u003Cstrong>Note\u003C/strong> that you might want to concatenate the files rather then copy the files because it could delete the\ncontents.\n\u003Cbr>\u003C/p>\n\u003Cp>Now all the containers share their public keys. Now we need to enable ssh server service.\u003Cbr>\nIt would not be needed to enable ssh server service and the following instructions on all machines, but I recommend to be sure.\nInstall \u003Ccode>openssh-server\u003C/code> and enable it by \u003Ccode>service ssh start\u003C/code>.\nIt is good to make the container automatically restart ssh server service every boot-up.\n\u003Cbr>\u003C/p>\n\u003Cp>Now the containers are ready to serve as a ssh server. However, there is one more step to do because of Docker containers.\nDefault ssh port is 22, and the same thing applies to the host machine.\nIt make things tough if every ssh connections are fed into the host's port 22.\u003Cbr>\nWe would best to open another port(i.g. 12345) of the host, and use it as a container's ssh server port.\nSince the host and the container share the network interface, the port is visible inside the container.\n\u003Cbr>\u003C/p>\n\u003Cp>One simple way to open port is to use \u003Ccode>ufw\u003C/code> (such as \u003Ccode>sudo ufw allow 12345\u003C/code>), or you can use \u003Ccode>iptables\u003C/code>.\nAnd then, you need to modify the default ssh server port on the container.\nGet inside the container and let us modify the ssh server configuration file \u003Ccode>/etc/ssh/sshd_config\u003C/code>.\nYou may see the line \u003Ccode>#Port 22\u003C/code>. Uncomment the line by deleting \u003Ccode>#\u003C/code> at the beginning and edit the port number.\n\u003Cbr>\u003C/p>\n\u003Cp>There is one more thing. You might be stuck after executing the command, seeing no output or error.\u003Cbr>\nThis is the result of not adding fingerprint of each machine. Try to ssh every other machine even if you have added\nthe public key into them.\n\u003Cbr>\u003C/p>\n\u003Ch2 id=\"3-3.-Run-Horovod\">3. Run Horovod\u003C/h2>\n\u003Cp>All docker containers, ssh server settings, port settings are done, and they are ready to run Horovod.\nOne example of \u003Ccode>Horovodrun\u003C/code> is:\u003C/p>\n\u003Cpre class=\"language-bash\">\u003Ccode class=\"language-bash code-highlight\">\u003Cspan class=\"code-line line-number\" line=\"1\">\u003Cspan class=\"token comment\"># 2 GPUs in local, 2 GPUs in remote\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"2\">horovodrun \u003Cspan class=\"token parameter variable\">-np\u003C/span> \u003Cspan class=\"token number\">4\u003C/span> \u003Cspan class=\"token parameter variable\">-H\u003C/span> localhost:2,123.123.123.123:2 \u003Cspan class=\"token parameter variable\">-p\u003C/span> \u003Cspan class=\"token number\">12345\u003C/span> \u003Cspan class=\"token punctuation\">\\\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"3\">    python scripts/tf_cnn_benchmarks/tf_cnn_benchmarks.py \u003Cspan class=\"token punctuation\">\\\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"4\">    \u003Cspan class=\"token parameter variable\">--model\u003C/span> resnet50 \u003Cspan class=\"token punctuation\">\\\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"5\">    \u003Cspan class=\"token parameter variable\">--batch_size\u003C/span> \u003Cspan class=\"token number\">16\u003C/span> \u003Cspan class=\"token punctuation\">\\\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"6\">    \u003Cspan class=\"token parameter variable\">--variable_update\u003C/span> horovod \u003Cspan class=\"token punctuation\">\\\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"7\">    --use_fp16\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The command will spawn two processes on the local machine, and different two processes on the machine with ip address \u003Ccode>123.123.123.123\u003C/code>.\nOf course the ip address is that of the remote host machine.\u003Cbr>\n\u003Cstrong>Note\u003C/strong> that the port number is specified as \u003Ccode>-p 12345\u003C/code>.\nThere is no way for Horovod to find out on its own which port to use for ssh communication, so you need to tell it.\n\u003Cbr>\u003C/p>\n\u003Cp>\u003Cimg src=\"/img/2021-01-19-run-horovod-across-machines/horovodrun1.png\" alt=\"horovodrun1.png\">\n\u003Cbr>\u003C/p>\n\u003Cp>\u003Cimg src=\"/img/2021-01-19-run-horovod-across-machines/horovodrun2.png\" alt=\"horovodrun2.png\">\n\u003Cbr>\u003C/p>\n\u003Cp>Looks like that was it. I will add more contents if I find something helpful.\u003C/p>",{"layout":3,"toc":4,"editedDate":5,"title":6,"category":7,"tags":9,"author":12},"post",true,"2021-12-05","Run Horovod across Multiple Machines inside Docker Container",[8],"Programming",[10,11],"Horovod","Docker",[13],"이현재","2021-01-19","eng",[17,21,24],{"depth":18,"id":19,"text":20},2,"1-1.-Run-(Install)-Docker-Image","1. Run (Install) Docker Image",{"depth":18,"id":22,"text":23},"2-2.-ssh-Settings","2. ssh Settings",{"depth":18,"id":25,"text":26},"3-3.-Run-Horovod","3. Run Horovod"],"uses":{"params":["year","slug"]}}]}
