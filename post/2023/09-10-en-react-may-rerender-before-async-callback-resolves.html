<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../../favicon.ico" />
		<meta name="viewport" content="width=device-width" />
		
		<link href="../../_app/immutable/assets/0.90721bd8.css" rel="stylesheet">
		<link rel="modulepreload" href="../../_app/immutable/entry/start.e57ba1b0.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/scheduler.6402f0dd.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/singletons.cc93c0d2.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/index.1b92e39a.js">
		<link rel="modulepreload" href="../../_app/immutable/entry/app.129fd98f.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/index.0cc09f3a.js">
		<link rel="modulepreload" href="../../_app/immutable/nodes/0.ef30cdad.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/index.a82faf3f.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/GithubMark.5170f17a.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/store.be990f37.js">
		<link rel="modulepreload" href="../../_app/immutable/nodes/5.4b0c7837.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/each.e59479a4.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/Category.af81e4ec.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/MainSection.49f196b2.js"><title>React may Rerender before Async Callback Resolves : dlguswo333&#39;s blog</title><!-- HEAD_svelte-etxm8u_START --><!-- HEAD_svelte-etxm8u_END -->
		<!-- [TODO] For portability I can erase the following elements and inject them from index.ts when building? -->
		<title>dlguswo333's Blog</title>
		<meta name="google-site-verification" content="GIhlBkE7qu5AWLVmQ4w2lBcxEw-AumQhdQf_2zR2X4s" />
	</head>
	<body data-sveltekit-preload-data="hover">
		<script>
			const systemTheme= window.matchMedia('(prefers-color-scheme:dark)').matches ? 'dark' : 'light';
			const rootElement = document.querySelector('body');
			try {
				const storedValue = JSON.parse(localStorage.getItem('color-theme') || 'null');
				const currentTheme = storedValue === 'light' || storedValue === 'dark' ? storedValue : systemTheme;
				if(rootElement) {
  				rootElement.classList.add(currentTheme);
				}
			} catch {
				rootElement.classList.add(systemTheme);
			}
		</script>
		<div id="root">  <header class="p-2 sticky top-0 flex flex-row items-center justify-between border-b border-b-gray-300 bg-gray-50 dark:bg-[#2c3039] dark:border-b-gray-700"><div class="flex flex-row items-center gap-1"> <a href="/" class="inline-block h-8 w-8" data-svelte-h="svelte-htzscq"><span class="hidden">Go To Home</span> <img src="/favicon.svg" alt="Logo"></a> <button type="button" title="Toggle color theme" class="group"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" class="h-8 w-8 transition"><rect x="3" y="3" width="94" height="94" stroke-width="6" rx="16" ry="16" class="stroke-gray-600 fill-none"></rect></svg></button> </div> <div class="flex flex-row items-center"><a href="/categories" class="h-8 flex items-center justify-center mr-2 last:mr-1 px-1 py-0.5 rounded hover:bg-gray-200 dark:hover:bg-slate-600 dark:hover:text-white">Categories</a> <a href="/tags" class="h-8 flex items-center justify-center mr-2 last:mr-1 px-1 py-0.5 rounded hover:bg-gray-200 dark:hover:bg-slate-600 dark:hover:text-white">Tags</a> <a href="/about" class="h-8 flex items-center justify-center mr-2 last:mr-1 px-1 py-0.5 rounded hover:bg-gray-200 dark:hover:bg-slate-600 dark:hover:text-white">About</a></div></header>  <div class="flex flex-row flex-grow justify-center p-2 lg:p-0 lg:pr-[300px]"> <aside class="w-[300px] overflow-hidden hidden mt-10 self-start md:!flex md:sticky md:top-14 flex-col justify-center items-center p-3
  "><div class="relative w-full"><ul class="max-h-[80vh] overflow-auto"></ul> </div></aside>  <div class="flex flex-col justify-center min-w-0"><div class="max-w-[900px] flex flex-col items-center py-6 gap-3"><h1 class="text-4xl font-bold text-center">React may Rerender before Async Callback Resolves</h1> <span>2023-09-10 </span> <button class="px-2 py-0.5 rounded-lg shadow-md shadow-emerald-50 border-l-slate-100 bg-sky-300 text-white hover:bg-sky-500 dark:shadow-emerald-900 transition">/Programming</button> <div><button class="last:mr-0 bg-green-100 hover:bg-green-400 hover:text-white dark:text-black transition px-2 py-0.5 rounded-xl shadow-md dark:shadow-green-900 my-0.5" style="margin-right: 0.25rem; margin-left: 0.5rem">#web</button><button class="last:mr-0 bg-green-100 hover:bg-green-400 hover:text-white dark:text-black transition px-2 py-0.5 rounded-xl shadow-md dark:shadow-green-900 my-0.5" style="margin-right: 0.25rem; margin-left: 0rem">#react</button><button class="last:mr-0 bg-green-100 hover:bg-green-400 hover:text-white dark:text-black transition px-2 py-0.5 rounded-xl shadow-md dark:shadow-green-900 my-0.5" style="margin-right: 0.25rem; margin-left: 0rem">#javascript</button></div></div> <hr class="bg-gray-400 my-4">  <main class="max-w-[900px] w-full py-2 post"> <!-- HTML_TAG_START --><p>In React, rerendering may run before async callbacks finish or resolve.</p>
<p>Think of a simple component which calls API and update its own state.
Upon the button click, the following function calls run in order: <code>onClick</code> => <code>updateState</code> => <code>api</code>.</p>
<pre class="language-jsx"><code class="language-jsx code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">const</span> <span class="token function-variable function"><span class="token maybe-class-name">Component</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">  <span class="token keyword">const</span> <span class="token function-variable function">api</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">currentValue</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="5">    <span class="token keyword control-flow">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token arrow operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// To mimic remote API call</span>
</span><span class="code-line line-number" line="6">    <span class="token keyword control-flow">return</span> currentValue <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="7">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9">  <span class="token keyword">const</span> <span class="token function-variable function">updateState</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="10">    <span class="token keyword">const</span> newValue <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">api</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="11">    <span class="token function">setState</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="12">  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14">  <span class="token keyword">const</span> <span class="token function-variable function">onClick</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="15">    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'log-0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="16">    <span class="token keyword control-flow">await</span> <span class="token function">updateState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="17">    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'log-1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="18">  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20">  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="21">    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'rerender'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="22">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="23">
</span><span class="code-line line-number" line="24">  <span class="token keyword control-flow">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
</span></span><span class="code-line line-number" line="25"><span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">Component </span><span class="token punctuation">{</span>state<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
</span></span><span class="code-line line-number" line="26"><span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">Click</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
</span></span><span class="code-line line-number" line="27"><span class="token plain-text">  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span></span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="28"><span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></code></pre>
<p><img src="/img/2023-09-10-react-may-rerender-before-async-callback-resolves/basic-component.gif" alt="basic-component"></p>
<p>Console prints out <code>log-0</code> => <code>log-1</code> => <code>rerender</code> in order.
I believe this is expected behavior for most of React developers.</p>
<hr>
<p>Then what if we have a local cache so that we dont need to call API?</p>
<pre class="language-jsx"><code class="language-jsx code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">const</span> <span class="token function-variable function">getCache</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  <span class="token keyword">const</span> entries <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="3">    <span class="token number">0</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    <span class="token number">1</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">    <span class="token number">2</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="7">  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token parameter">currentValue</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="8">    <span class="token keyword control-flow">return</span> entries<span class="token punctuation">[</span>currentValue<span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="9">  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="10"><span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12"><span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token function">getCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<p>Let's integrate the cache into the component.</p>
<pre class="language-jsx"><code class="language-jsx code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">const</span> <span class="token function-variable function"><span class="token maybe-class-name">CacheComp</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">  <span class="token keyword">const</span> <span class="token function-variable function">api</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">currentValue</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="5">    <span class="token keyword control-flow">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token arrow operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="6">    <span class="token keyword control-flow">return</span> currentValue <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="7">  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9">  <span class="token keyword">const</span> <span class="token function-variable function">updateState</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="10">    <span class="token keyword">const</span> cachedValue <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="11">    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>cachedValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="12">      <span class="token function">setState</span><span class="token punctuation">(</span>cachedValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="13">      <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="14">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="15">    <span class="token keyword">const</span> newValue <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">api</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="16">    <span class="token function">setState</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="17">  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">  <span class="token keyword">const</span> <span class="token function-variable function">onClick</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="20">    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'log-0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="21">    <span class="token keyword control-flow">await</span> <span class="token function">updateState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="22">    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'log-1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="23">  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25">  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="26">    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'rerender'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="27">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="28">
</span><span class="code-line line-number" line="29">  <span class="token keyword control-flow">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
</span></span><span class="code-line line-number" line="30"><span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">Component with cache </span><span class="token punctuation">{</span>state<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
</span></span><span class="code-line line-number" line="31"><span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">Click</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
</span></span><span class="code-line line-number" line="32"><span class="token plain-text">  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span></span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="33"><span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="34">
</span><span class="code-line line-number" line="35"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token maybe-class-name">CacheComp</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="36">
</span></code></pre>
<p><img src="/img/2023-09-10-react-may-rerender-before-async-callback-resolves/component-with-cache.gif" alt="component-with-cache"></p>
<p>It outputs <code>log-0</code> => <code>rerender</code> => <code>log-1</code>.</p>
<p>Is this expected behavior? I think not.
before even <code>onClick</code> function finishes (= the promise returned by <code>updateState</code> resolves),
React updates states (= rerender by <code>setState(newValue)</code>).</p>
<p>I have no idea what is the root cause for this phenomenon,
but it has something to do that <code>updateState</code> function is <code>async</code> function but
the statements it executes when cache hits occur are actually <code>sync</code>.</p>
<pre class="language-jsx"><code class="language-jsx code-highlight"><span class="code-line line-number" line="1">  <span class="token comment">// If cache hits...</span>
</span><span class="code-line line-number" line="2">  <span class="token keyword">const</span> <span class="token function-variable function">updateState</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="3">    <span class="token keyword">const</span> cachedValue <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="4">    <span class="token function">setState</span><span class="token punctuation">(</span>cachedValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="5">    <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="6">  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></code></pre>
<p>After <code>setState</code> runs, <code>onClick</code> waits for <code>updateState()</code> to resolve.
In the meantime, React decided to rerender for some reasons.</p>
<hr>
<p>Think of another example where multiple states are defined and get updated.</p>
<pre class="language-jsx"><code class="language-jsx code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">const</span> <span class="token function-variable function"><span class="token maybe-class-name">MultiCacheComp</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  <span class="token keyword">const</span> <span class="token punctuation">[</span>state1<span class="token punctuation">,</span> setState1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="3">  <span class="token keyword">const</span> <span class="token punctuation">[</span>state2<span class="token punctuation">,</span> setState2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5">  <span class="token keyword">const</span> <span class="token function-variable function">api</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">currentValue</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="6">    <span class="token keyword control-flow">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token arrow operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="7">    <span class="token keyword control-flow">return</span> currentValue <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="8">  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10">  <span class="token keyword">const</span> <span class="token function-variable function">updateState</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="11">    <span class="token keyword">const</span> cachedValue1 <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>state1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="12">    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>cachedValue1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="13">      <span class="token function">setState1</span><span class="token punctuation">(</span>cachedValue1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="14">    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="15">      <span class="token keyword">const</span> newValue1 <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">api</span><span class="token punctuation">(</span>state1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="16">      <span class="token function">setState1</span><span class="token punctuation">(</span>newValue1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="17">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">    <span class="token keyword">const</span> cachedValue2 <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>state2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="20">    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>cachedValue2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="21">      <span class="token function">setState2</span><span class="token punctuation">(</span>cachedValue2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="22">    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="23">      <span class="token keyword">const</span> newValue2 <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">api</span><span class="token punctuation">(</span>state2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="24">      <span class="token function">setState2</span><span class="token punctuation">(</span>newValue2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="25">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="26">  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="27">
</span><span class="code-line line-number" line="28">  <span class="token keyword">const</span> <span class="token function-variable function">onClick</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="29">    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'log-0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="30">    <span class="token keyword control-flow">await</span> <span class="token function">updateState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="31">    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'log-1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="32">  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="33">
</span><span class="code-line line-number" line="34">  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="35">    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'rerender'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="36">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="37">
</span><span class="code-line line-number" line="38">  <span class="token keyword control-flow">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
</span></span><span class="code-line line-number" line="39"><span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">Component with cache </span><span class="token punctuation">{</span>state1<span class="token punctuation">}</span><span class="token plain-text"> </span><span class="token punctuation">{</span>state2<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
</span></span><span class="code-line line-number" line="40"><span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">Click</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
</span></span><span class="code-line line-number" line="41"><span class="token plain-text">  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span></span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="42"><span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></code></pre>
<p><img src="/img/2023-09-10-react-may-rerender-before-async-callback-resolves/component-with-multi-states.gif" alt="component-with-multi-states"></p>
<p>It outputs <code>log-0</code> => <code>rerender</code> => <code>log-1</code>.
But if cache misses occur, it outputs <code>log-0</code> => <code>rerender</code> => <code>log-1</code> => <code>rerender</code>.</p>
<hr>
<p>These examples may seem too unnatural compared to codes on the real world.
But believe me, I encountered this problem while developing for real use cases.
If <strong>we have some codes that need to run before rerendering</strong>,
then we have a problem.</p>
<p>These kinds of caveats hit us so hard wasting our times.
But don't get me wrong. I do think this is not a React's problem.
The issue I have been describing is not an easy one to solve.
We have no way to tell when API calls will return the values.
In the meantime, React must decide when to rerender, without ruining user experiences on web pages.</p>
<p>The conclusion is <strong>do not assume asynchronous callbacks will finish before rerendering</strong>.
Keep in mind that React may rerender earlier for its own sakes.</p><!-- HTML_TAG_END --></main></div></div> <footer class="p-2 py-5 text-sm flex gap-1 flex-col md:flex-row items-center justify-between border-t border-gray-300 bg-gray-50 dark:border-gray-700 dark:bg-[#2c3039]"><div>©️ 2021~2023 dlguswo333; All rights reserved.</div> <div class="flex items-center"><a class="inline-flex items-center" href="https://github.com/dlguswo333/dlguswo333.github.io"><img class="inline h-4 w-4 mr-1" src="/github-mark.svg" alt="github-mark"></a>
    Built with Sveltekit.</div></footer>  
			
			<script>
				{
					__sveltekit_60r45a = {
						base: new URL("../..", location).pathname.slice(0, -1),
						env: {}
					};

					const element = document.currentScript.parentElement;

					const data = [null,{"type":"data","data":{html:"\u003Cp>In React, rerendering may run before async callbacks finish or resolve.\u003C/p>\n\u003Cp>Think of a simple component which calls API and update its own state.\nUpon the button click, the following function calls run in order: \u003Ccode>onClick\u003C/code> => \u003Ccode>updateState\u003C/code> => \u003Ccode>api\u003C/code>.\u003C/p>\n\u003Cpre class=\"language-jsx\">\u003Ccode class=\"language-jsx code-highlight\">\u003Cspan class=\"code-line line-number\" line=\"1\">\u003Cspan class=\"token keyword\">const\u003C/span> \u003Cspan class=\"token function-variable function\">\u003Cspan class=\"token maybe-class-name\">Component\u003C/span>\u003C/span> \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"2\">  \u003Cspan class=\"token keyword\">const\u003C/span> \u003Cspan class=\"token punctuation\">[\u003C/span>state\u003Cspan class=\"token punctuation\">,\u003C/span> setState\u003Cspan class=\"token punctuation\">]\u003C/span> \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token function\">useState\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token number\">0\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"3\">\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"4\">  \u003Cspan class=\"token keyword\">const\u003C/span> \u003Cspan class=\"token function-variable function\">api\u003C/span> \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token keyword\">async\u003C/span> \u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token parameter\">currentValue\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"5\">    \u003Cspan class=\"token keyword control-flow\">await\u003C/span> \u003Cspan class=\"token keyword\">new\u003C/span> \u003Cspan class=\"token class-name\">Promise\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token parameter\">res\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token function\">setTimeout\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>res\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span> \u003Cspan class=\"token comment\">// To mimic remote API call\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"6\">    \u003Cspan class=\"token keyword control-flow\">return\u003C/span> currentValue \u003Cspan class=\"token operator\">+\u003C/span> \u003Cspan class=\"token number\">1\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"7\">  \u003Cspan class=\"token punctuation\">}\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"8\">\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"9\">  \u003Cspan class=\"token keyword\">const\u003C/span> \u003Cspan class=\"token function-variable function\">updateState\u003C/span> \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token keyword\">async\u003C/span> \u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"10\">    \u003Cspan class=\"token keyword\">const\u003C/span> newValue \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token keyword control-flow\">await\u003C/span> \u003Cspan class=\"token function\">api\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>state\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"11\">    \u003Cspan class=\"token function\">setState\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>newValue\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"12\">  \u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"13\">\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"14\">  \u003Cspan class=\"token keyword\">const\u003C/span> \u003Cspan class=\"token function-variable function\">onClick\u003C/span> \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token keyword\">async\u003C/span> \u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"15\">    \u003Cspan class=\"token console class-name\">console\u003C/span>\u003Cspan class=\"token punctuation\">.\u003C/span>\u003Cspan class=\"token method function property-access\">log\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token string\">'log-0'\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"16\">    \u003Cspan class=\"token keyword control-flow\">await\u003C/span> \u003Cspan class=\"token function\">updateState\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"17\">    \u003Cspan class=\"token console class-name\">console\u003C/span>\u003Cspan class=\"token punctuation\">.\u003C/span>\u003Cspan class=\"token method function property-access\">log\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token string\">'log-1'\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"18\">  \u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"19\">\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"20\">  \u003Cspan class=\"token function\">useEffect\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"21\">    \u003Cspan class=\"token console class-name\">console\u003C/span>\u003Cspan class=\"token punctuation\">.\u003C/span>\u003Cspan class=\"token method function property-access\">log\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token string\">'rerender'\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"22\">  \u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"23\">\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"24\">  \u003Cspan class=\"token keyword control-flow\">return\u003C/span> \u003Cspan class=\"token tag\">\u003Cspan class=\"token tag\">\u003Cspan class=\"token punctuation\">&#x3C;\u003C/span>\u003C/span>\u003Cspan class=\"token punctuation\">>\u003C/span>\u003C/span>\u003Cspan class=\"token plain-text\">\n\u003C/span>\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"25\">\u003Cspan class=\"token plain-text\">    \u003C/span>\u003Cspan class=\"token tag\">\u003Cspan class=\"token tag\">\u003Cspan class=\"token punctuation\">&#x3C;\u003C/span>div\u003C/span>\u003Cspan class=\"token punctuation\">>\u003C/span>\u003C/span>\u003Cspan class=\"token plain-text\">Component \u003C/span>\u003Cspan class=\"token punctuation\">{\u003C/span>state\u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token tag\">\u003Cspan class=\"token tag\">\u003Cspan class=\"token punctuation\">&#x3C;/\u003C/span>div\u003C/span>\u003Cspan class=\"token punctuation\">>\u003C/span>\u003C/span>\u003Cspan class=\"token plain-text\">\n\u003C/span>\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"26\">\u003Cspan class=\"token plain-text\">    \u003C/span>\u003Cspan class=\"token tag\">\u003Cspan class=\"token tag\">\u003Cspan class=\"token punctuation\">&#x3C;\u003C/span>button\u003C/span> \u003Cspan class=\"token attr-name\">onClick\u003C/span>\u003Cspan class=\"token script language-javascript\">\u003Cspan class=\"token script-punctuation punctuation\">=\u003C/span>\u003Cspan class=\"token punctuation\">{\u003C/span>onClick\u003Cspan class=\"token punctuation\">}\u003C/span>\u003C/span>\u003Cspan class=\"token punctuation\">>\u003C/span>\u003C/span>\u003Cspan class=\"token plain-text\">Click\u003C/span>\u003Cspan class=\"token tag\">\u003Cspan class=\"token tag\">\u003Cspan class=\"token punctuation\">&#x3C;/\u003C/span>button\u003C/span>\u003Cspan class=\"token punctuation\">>\u003C/span>\u003C/span>\u003Cspan class=\"token plain-text\">\n\u003C/span>\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"27\">\u003Cspan class=\"token plain-text\">  \u003C/span>\u003Cspan class=\"token tag\">\u003Cspan class=\"token tag\">\u003Cspan class=\"token punctuation\">&#x3C;/\u003C/span>\u003C/span>\u003Cspan class=\"token punctuation\">>\u003C/span>\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"28\">\u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cimg src=\"/img/2023-09-10-react-may-rerender-before-async-callback-resolves/basic-component.gif\" alt=\"basic-component\">\u003C/p>\n\u003Cp>Console prints out \u003Ccode>log-0\u003C/code> => \u003Ccode>log-1\u003C/code> => \u003Ccode>rerender\u003C/code> in order.\nI believe this is expected behavior for most of React developers.\u003C/p>\n\u003Chr>\n\u003Cp>Then what if we have a local cache so that we dont need to call API?\u003C/p>\n\u003Cpre class=\"language-jsx\">\u003Ccode class=\"language-jsx code-highlight\">\u003Cspan class=\"code-line line-number\" line=\"1\">\u003Cspan class=\"token keyword\">const\u003C/span> \u003Cspan class=\"token function-variable function\">getCache\u003C/span> \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"2\">  \u003Cspan class=\"token keyword\">const\u003C/span> entries \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"3\">    \u003Cspan class=\"token number\">0\u003C/span>\u003Cspan class=\"token operator\">:\u003C/span> \u003Cspan class=\"token number\">1\u003C/span>\u003Cspan class=\"token punctuation\">,\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"4\">    \u003Cspan class=\"token number\">1\u003C/span>\u003Cspan class=\"token operator\">:\u003C/span> \u003Cspan class=\"token number\">2\u003C/span>\u003Cspan class=\"token punctuation\">,\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"5\">    \u003Cspan class=\"token number\">2\u003C/span>\u003Cspan class=\"token operator\">:\u003C/span> \u003Cspan class=\"token number\">3\u003C/span>\u003Cspan class=\"token punctuation\">,\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"6\">  \u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"7\">  \u003Cspan class=\"token keyword control-flow\">return\u003C/span> \u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token parameter\">currentValue\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"8\">    \u003Cspan class=\"token keyword control-flow\">return\u003C/span> entries\u003Cspan class=\"token punctuation\">[\u003C/span>currentValue\u003Cspan class=\"token punctuation\">]\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"9\">  \u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"10\">\u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"11\">\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"12\">\u003Cspan class=\"token keyword\">const\u003C/span> cache \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token function\">getCache\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Let's integrate the cache into the component.\u003C/p>\n\u003Cpre class=\"language-jsx\">\u003Ccode class=\"language-jsx code-highlight\">\u003Cspan class=\"code-line line-number\" line=\"1\">\u003Cspan class=\"token keyword\">const\u003C/span> \u003Cspan class=\"token function-variable function\">\u003Cspan class=\"token maybe-class-name\">CacheComp\u003C/span>\u003C/span> \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"2\">  \u003Cspan class=\"token keyword\">const\u003C/span> \u003Cspan class=\"token punctuation\">[\u003C/span>state\u003Cspan class=\"token punctuation\">,\u003C/span> setState\u003Cspan class=\"token punctuation\">]\u003C/span> \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token function\">useState\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token number\">0\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"3\">\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"4\">  \u003Cspan class=\"token keyword\">const\u003C/span> \u003Cspan class=\"token function-variable function\">api\u003C/span> \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token keyword\">async\u003C/span> \u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token parameter\">currentValue\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"5\">    \u003Cspan class=\"token keyword control-flow\">await\u003C/span> \u003Cspan class=\"token keyword\">new\u003C/span> \u003Cspan class=\"token class-name\">Promise\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token parameter\">res\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token function\">setTimeout\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>res\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"6\">    \u003Cspan class=\"token keyword control-flow\">return\u003C/span> currentValue \u003Cspan class=\"token operator\">+\u003C/span> \u003Cspan class=\"token number\">1\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"7\">  \u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"8\">\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"9\">  \u003Cspan class=\"token keyword\">const\u003C/span> \u003Cspan class=\"token function-variable function\">updateState\u003C/span> \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token keyword\">async\u003C/span> \u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"10\">    \u003Cspan class=\"token keyword\">const\u003C/span> cachedValue \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token function\">cache\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>state\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"11\">    \u003Cspan class=\"token keyword control-flow\">if\u003C/span> \u003Cspan class=\"token punctuation\">(\u003C/span>cachedValue\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"12\">      \u003Cspan class=\"token function\">setState\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>cachedValue\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"13\">      \u003Cspan class=\"token keyword control-flow\">return\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"14\">    \u003Cspan class=\"token punctuation\">}\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"15\">    \u003Cspan class=\"token keyword\">const\u003C/span> newValue \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token keyword control-flow\">await\u003C/span> \u003Cspan class=\"token function\">api\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>state\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"16\">    \u003Cspan class=\"token function\">setState\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>newValue\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"17\">  \u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"18\">\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"19\">  \u003Cspan class=\"token keyword\">const\u003C/span> \u003Cspan class=\"token function-variable function\">onClick\u003C/span> \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token keyword\">async\u003C/span> \u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"20\">    \u003Cspan class=\"token console class-name\">console\u003C/span>\u003Cspan class=\"token punctuation\">.\u003C/span>\u003Cspan class=\"token method function property-access\">log\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token string\">'log-0'\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"21\">    \u003Cspan class=\"token keyword control-flow\">await\u003C/span> \u003Cspan class=\"token function\">updateState\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"22\">    \u003Cspan class=\"token console class-name\">console\u003C/span>\u003Cspan class=\"token punctuation\">.\u003C/span>\u003Cspan class=\"token method function property-access\">log\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token string\">'log-1'\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"23\">  \u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"24\">\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"25\">  \u003Cspan class=\"token function\">useEffect\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"26\">    \u003Cspan class=\"token console class-name\">console\u003C/span>\u003Cspan class=\"token punctuation\">.\u003C/span>\u003Cspan class=\"token method function property-access\">log\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token string\">'rerender'\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"27\">  \u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"28\">\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"29\">  \u003Cspan class=\"token keyword control-flow\">return\u003C/span> \u003Cspan class=\"token tag\">\u003Cspan class=\"token tag\">\u003Cspan class=\"token punctuation\">&#x3C;\u003C/span>\u003C/span>\u003Cspan class=\"token punctuation\">>\u003C/span>\u003C/span>\u003Cspan class=\"token plain-text\">\n\u003C/span>\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"30\">\u003Cspan class=\"token plain-text\">    \u003C/span>\u003Cspan class=\"token tag\">\u003Cspan class=\"token tag\">\u003Cspan class=\"token punctuation\">&#x3C;\u003C/span>div\u003C/span>\u003Cspan class=\"token punctuation\">>\u003C/span>\u003C/span>\u003Cspan class=\"token plain-text\">Component with cache \u003C/span>\u003Cspan class=\"token punctuation\">{\u003C/span>state\u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token tag\">\u003Cspan class=\"token tag\">\u003Cspan class=\"token punctuation\">&#x3C;/\u003C/span>div\u003C/span>\u003Cspan class=\"token punctuation\">>\u003C/span>\u003C/span>\u003Cspan class=\"token plain-text\">\n\u003C/span>\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"31\">\u003Cspan class=\"token plain-text\">    \u003C/span>\u003Cspan class=\"token tag\">\u003Cspan class=\"token tag\">\u003Cspan class=\"token punctuation\">&#x3C;\u003C/span>button\u003C/span> \u003Cspan class=\"token attr-name\">onClick\u003C/span>\u003Cspan class=\"token script language-javascript\">\u003Cspan class=\"token script-punctuation punctuation\">=\u003C/span>\u003Cspan class=\"token punctuation\">{\u003C/span>onClick\u003Cspan class=\"token punctuation\">}\u003C/span>\u003C/span>\u003Cspan class=\"token punctuation\">>\u003C/span>\u003C/span>\u003Cspan class=\"token plain-text\">Click\u003C/span>\u003Cspan class=\"token tag\">\u003Cspan class=\"token tag\">\u003Cspan class=\"token punctuation\">&#x3C;/\u003C/span>button\u003C/span>\u003Cspan class=\"token punctuation\">>\u003C/span>\u003C/span>\u003Cspan class=\"token plain-text\">\n\u003C/span>\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"32\">\u003Cspan class=\"token plain-text\">  \u003C/span>\u003Cspan class=\"token tag\">\u003Cspan class=\"token tag\">\u003Cspan class=\"token punctuation\">&#x3C;/\u003C/span>\u003C/span>\u003Cspan class=\"token punctuation\">>\u003C/span>\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"33\">\u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"34\">\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"35\">\u003Cspan class=\"token keyword module\">export\u003C/span> \u003Cspan class=\"token keyword module\">default\u003C/span> \u003Cspan class=\"token maybe-class-name\">CacheComp\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"36\">\n\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cimg src=\"/img/2023-09-10-react-may-rerender-before-async-callback-resolves/component-with-cache.gif\" alt=\"component-with-cache\">\u003C/p>\n\u003Cp>It outputs \u003Ccode>log-0\u003C/code> => \u003Ccode>rerender\u003C/code> => \u003Ccode>log-1\u003C/code>.\u003C/p>\n\u003Cp>Is this expected behavior? I think not.\nbefore even \u003Ccode>onClick\u003C/code> function finishes (= the promise returned by \u003Ccode>updateState\u003C/code> resolves),\nReact updates states (= rerender by \u003Ccode>setState(newValue)\u003C/code>).\u003C/p>\n\u003Cp>I have no idea what is the root cause for this phenomenon,\nbut it has something to do that \u003Ccode>updateState\u003C/code> function is \u003Ccode>async\u003C/code> function but\nthe statements it executes when cache hits occur are actually \u003Ccode>sync\u003C/code>.\u003C/p>\n\u003Cpre class=\"language-jsx\">\u003Ccode class=\"language-jsx code-highlight\">\u003Cspan class=\"code-line line-number\" line=\"1\">  \u003Cspan class=\"token comment\">// If cache hits...\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"2\">  \u003Cspan class=\"token keyword\">const\u003C/span> \u003Cspan class=\"token function-variable function\">updateState\u003C/span> \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token keyword\">async\u003C/span> \u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"3\">    \u003Cspan class=\"token keyword\">const\u003C/span> cachedValue \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token function\">cache\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>state\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"4\">    \u003Cspan class=\"token function\">setState\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>cachedValue\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"5\">    \u003Cspan class=\"token keyword control-flow\">return\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"6\">  \u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>After \u003Ccode>setState\u003C/code> runs, \u003Ccode>onClick\u003C/code> waits for \u003Ccode>updateState()\u003C/code> to resolve.\nIn the meantime, React decided to rerender for some reasons.\u003C/p>\n\u003Chr>\n\u003Cp>Think of another example where multiple states are defined and get updated.\u003C/p>\n\u003Cpre class=\"language-jsx\">\u003Ccode class=\"language-jsx code-highlight\">\u003Cspan class=\"code-line line-number\" line=\"1\">\u003Cspan class=\"token keyword\">const\u003C/span> \u003Cspan class=\"token function-variable function\">\u003Cspan class=\"token maybe-class-name\">MultiCacheComp\u003C/span>\u003C/span> \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"2\">  \u003Cspan class=\"token keyword\">const\u003C/span> \u003Cspan class=\"token punctuation\">[\u003C/span>state1\u003Cspan class=\"token punctuation\">,\u003C/span> setState1\u003Cspan class=\"token punctuation\">]\u003C/span> \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token function\">useState\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token number\">0\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"3\">  \u003Cspan class=\"token keyword\">const\u003C/span> \u003Cspan class=\"token punctuation\">[\u003C/span>state2\u003Cspan class=\"token punctuation\">,\u003C/span> setState2\u003Cspan class=\"token punctuation\">]\u003C/span> \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token function\">useState\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token number\">0\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"4\">\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"5\">  \u003Cspan class=\"token keyword\">const\u003C/span> \u003Cspan class=\"token function-variable function\">api\u003C/span> \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token keyword\">async\u003C/span> \u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token parameter\">currentValue\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"6\">    \u003Cspan class=\"token keyword control-flow\">await\u003C/span> \u003Cspan class=\"token keyword\">new\u003C/span> \u003Cspan class=\"token class-name\">Promise\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token parameter\">res\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token function\">setTimeout\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>res\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"7\">    \u003Cspan class=\"token keyword control-flow\">return\u003C/span> currentValue \u003Cspan class=\"token operator\">+\u003C/span> \u003Cspan class=\"token number\">1\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"8\">  \u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"9\">\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"10\">  \u003Cspan class=\"token keyword\">const\u003C/span> \u003Cspan class=\"token function-variable function\">updateState\u003C/span> \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token keyword\">async\u003C/span> \u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"11\">    \u003Cspan class=\"token keyword\">const\u003C/span> cachedValue1 \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token function\">cache\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>state1\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"12\">    \u003Cspan class=\"token keyword control-flow\">if\u003C/span> \u003Cspan class=\"token punctuation\">(\u003C/span>cachedValue1\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"13\">      \u003Cspan class=\"token function\">setState1\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>cachedValue1\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"14\">    \u003Cspan class=\"token punctuation\">}\u003C/span> \u003Cspan class=\"token keyword control-flow\">else\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"15\">      \u003Cspan class=\"token keyword\">const\u003C/span> newValue1 \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token keyword control-flow\">await\u003C/span> \u003Cspan class=\"token function\">api\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>state1\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"16\">      \u003Cspan class=\"token function\">setState1\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>newValue1\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"17\">    \u003Cspan class=\"token punctuation\">}\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"18\">\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"19\">    \u003Cspan class=\"token keyword\">const\u003C/span> cachedValue2 \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token function\">cache\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>state2\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"20\">    \u003Cspan class=\"token keyword control-flow\">if\u003C/span> \u003Cspan class=\"token punctuation\">(\u003C/span>cachedValue2\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"21\">      \u003Cspan class=\"token function\">setState2\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>cachedValue2\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"22\">    \u003Cspan class=\"token punctuation\">}\u003C/span> \u003Cspan class=\"token keyword control-flow\">else\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"23\">      \u003Cspan class=\"token keyword\">const\u003C/span> newValue2 \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token keyword control-flow\">await\u003C/span> \u003Cspan class=\"token function\">api\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>state2\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"24\">      \u003Cspan class=\"token function\">setState2\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>newValue2\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"25\">    \u003Cspan class=\"token punctuation\">}\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"26\">  \u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"27\">\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"28\">  \u003Cspan class=\"token keyword\">const\u003C/span> \u003Cspan class=\"token function-variable function\">onClick\u003C/span> \u003Cspan class=\"token operator\">=\u003C/span> \u003Cspan class=\"token keyword\">async\u003C/span> \u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"29\">    \u003Cspan class=\"token console class-name\">console\u003C/span>\u003Cspan class=\"token punctuation\">.\u003C/span>\u003Cspan class=\"token method function property-access\">log\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token string\">'log-0'\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"30\">    \u003Cspan class=\"token keyword control-flow\">await\u003C/span> \u003Cspan class=\"token function\">updateState\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"31\">    \u003Cspan class=\"token console class-name\">console\u003C/span>\u003Cspan class=\"token punctuation\">.\u003C/span>\u003Cspan class=\"token method function property-access\">log\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token string\">'log-1'\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"32\">  \u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"33\">\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"34\">  \u003Cspan class=\"token function\">useEffect\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span> \u003Cspan class=\"token arrow operator\">=>\u003C/span> \u003Cspan class=\"token punctuation\">{\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"35\">    \u003Cspan class=\"token console class-name\">console\u003C/span>\u003Cspan class=\"token punctuation\">.\u003C/span>\u003Cspan class=\"token method function property-access\">log\u003C/span>\u003Cspan class=\"token punctuation\">(\u003C/span>\u003Cspan class=\"token string\">'rerender'\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"36\">  \u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token punctuation\">)\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"37\">\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"38\">  \u003Cspan class=\"token keyword control-flow\">return\u003C/span> \u003Cspan class=\"token tag\">\u003Cspan class=\"token tag\">\u003Cspan class=\"token punctuation\">&#x3C;\u003C/span>\u003C/span>\u003Cspan class=\"token punctuation\">>\u003C/span>\u003C/span>\u003Cspan class=\"token plain-text\">\n\u003C/span>\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"39\">\u003Cspan class=\"token plain-text\">    \u003C/span>\u003Cspan class=\"token tag\">\u003Cspan class=\"token tag\">\u003Cspan class=\"token punctuation\">&#x3C;\u003C/span>div\u003C/span>\u003Cspan class=\"token punctuation\">>\u003C/span>\u003C/span>\u003Cspan class=\"token plain-text\">Component with cache \u003C/span>\u003Cspan class=\"token punctuation\">{\u003C/span>state1\u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token plain-text\"> \u003C/span>\u003Cspan class=\"token punctuation\">{\u003C/span>state2\u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token tag\">\u003Cspan class=\"token tag\">\u003Cspan class=\"token punctuation\">&#x3C;/\u003C/span>div\u003C/span>\u003Cspan class=\"token punctuation\">>\u003C/span>\u003C/span>\u003Cspan class=\"token plain-text\">\n\u003C/span>\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"40\">\u003Cspan class=\"token plain-text\">    \u003C/span>\u003Cspan class=\"token tag\">\u003Cspan class=\"token tag\">\u003Cspan class=\"token punctuation\">&#x3C;\u003C/span>button\u003C/span> \u003Cspan class=\"token attr-name\">onClick\u003C/span>\u003Cspan class=\"token script language-javascript\">\u003Cspan class=\"token script-punctuation punctuation\">=\u003C/span>\u003Cspan class=\"token punctuation\">{\u003C/span>onClick\u003Cspan class=\"token punctuation\">}\u003C/span>\u003C/span>\u003Cspan class=\"token punctuation\">>\u003C/span>\u003C/span>\u003Cspan class=\"token plain-text\">Click\u003C/span>\u003Cspan class=\"token tag\">\u003Cspan class=\"token tag\">\u003Cspan class=\"token punctuation\">&#x3C;/\u003C/span>button\u003C/span>\u003Cspan class=\"token punctuation\">>\u003C/span>\u003C/span>\u003Cspan class=\"token plain-text\">\n\u003C/span>\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"41\">\u003Cspan class=\"token plain-text\">  \u003C/span>\u003Cspan class=\"token tag\">\u003Cspan class=\"token tag\">\u003Cspan class=\"token punctuation\">&#x3C;/\u003C/span>\u003C/span>\u003Cspan class=\"token punctuation\">>\u003C/span>\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003Cspan class=\"code-line line-number\" line=\"42\">\u003Cspan class=\"token punctuation\">}\u003C/span>\u003Cspan class=\"token punctuation\">;\u003C/span>\n\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cimg src=\"/img/2023-09-10-react-may-rerender-before-async-callback-resolves/component-with-multi-states.gif\" alt=\"component-with-multi-states\">\u003C/p>\n\u003Cp>It outputs \u003Ccode>log-0\u003C/code> => \u003Ccode>rerender\u003C/code> => \u003Ccode>log-1\u003C/code>.\nBut if cache misses occur, it outputs \u003Ccode>log-0\u003C/code> => \u003Ccode>rerender\u003C/code> => \u003Ccode>log-1\u003C/code> => \u003Ccode>rerender\u003C/code>.\u003C/p>\n\u003Chr>\n\u003Cp>These examples may seem too unnatural compared to codes on the real world.\nBut believe me, I encountered this problem while developing for real use cases.\nIf \u003Cstrong>we have some codes that need to run before rerendering\u003C/strong>,\nthen we have a problem.\u003C/p>\n\u003Cp>These kinds of caveats hit us so hard wasting our times.\nBut don't get me wrong. I do think this is not a React's problem.\nThe issue I have been describing is not an easy one to solve.\nWe have no way to tell when API calls will return the values.\nIn the meantime, React must decide when to rerender, without ruining user experiences on web pages.\u003C/p>\n\u003Cp>The conclusion is \u003Cstrong>do not assume asynchronous callbacks will finish before rerendering\u003C/strong>.\nKeep in mind that React may rerender earlier for its own sakes.\u003C/p>",frontmatter:{layout:"post",toc:false,title:"React may Rerender before Async Callback Resolves",category:["Programming"],tags:["web","react","javascript"],author:["이현재"]},date:"2023-09-10",lang:"en",tocData:[]},"uses":{"params":["year","slug"]}}];

					Promise.all([
						import("../../_app/immutable/entry/start.e57ba1b0.js"),
						import("../../_app/immutable/entry/app.129fd98f.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 5],
							data,
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
